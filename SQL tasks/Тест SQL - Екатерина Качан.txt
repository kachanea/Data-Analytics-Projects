Таблицы:

SELECT        [Код магазина], [Дата продаж], [Прогноз продаж]
FROM            Тест_ПрогнозПродаж

SELECT        Филиал, Город, Формат, [Код магазина], [Дата открытия], [Дата закрытия]
FROM            Тест_Магазины


SELECT        [Код магазина], Имя, Формат, POTENTIAL
FROM            V_WHS


--- Используя таблицы Тест_ПрогнозПродаж и Тест_Магазины выполнить следующие задания:

-- 1. Показать магазины всех форматов, которые закроются в течении 30 дней
-- 2. Посчитать прогноз продаж по магазинам формата МД в городе Петрозаводск с 13.02 по 28.02
-- 3. Определить количество действующих объектов формата МА
-- 4. Определить, в каком филиале самый большой прогноз продаж на Июль по каждому формату
-- 5. Показать магазины, у которых прогноз продаж от 2 до 4 млн. р. в Июле
-- 6. Показать средний прогноз продаж по каждому филиалу
-- 7. Определить ТОП 5 магазинов с максимальными продажами в каждом месяце
-- 8. Выбрать из V_WHS торговый объект с 4-м от минимального уровнем потенциала. Подсказка: рекомендуется использовать ранжирование
-- 9. Составить запрос, который всегда будет показывать дату вчерашнего числа со временем 2:21.


-------------------------------------------------------------------------------------------
PostgreSQL


-- 1. Показать магазины всех форматов, которые закроются в течении 30 дней

	SELECT *
	FROM Тест_Магазины
	WHERE DATE("Дата закрытия") BETWEEN current_date AND (current_date + INTERVAL '30 day');





-- 2. Посчитать прогноз продаж по магазинам формата МД в городе Петрозаводск с 13.02 по 28.02

	SELECT "Код магазина", SUM("Прогноз продаж")
	FROM Тест_ПрогнозПродаж
	WHERE "Код магазина" IN 
			(SELECT "Код магазина"
			FROM Тест_Магазины 
			WHERE "Формат" = 'МД' AND "Город" = 'Петрозаводск')

		AND DATE("Дата продаж") BETWEEN '2025-02-13' AND '2025-02-28'
	GROUP BY "Код магазина";





-- 3. Определить количество действующих объектов формата МА

	SELECT COUNT("Код магазина")
	FROM Тест_Магазины 
	WHERE "Формат" = 'МА' 
		AND DATE("Дата закрытия") > current_date 
		AND DATE("Дата открытия") <= current_date;




-- 4. Определить, в каком филиале самый большой прогноз продаж на Июль по каждому формату

	WITH "Ранжирование" AS (
		SELECT  m."Филиал", m."Формат", 
			SUM(p."Прогноз продаж") AS "Суммарные продажи",
			ROW_NUMBER() OVER (PARTITION BY "Формат" ORDER BY SUM(p."Прогноз продаж") DESC) AS "Ранг"
		FROM  Тест_Магазины AS m
		JOIN Тест_ПрогнозПродаж AS p ON m."Код магазина" = p."Код магазина" 
		WHERE DATE_TRUNC('month', p."Дата продаж") = '2024-07-01'
		GROUP BY m."Формат", m."Филиал")

	SELECT "Формат", "Филиал", "Суммарные продажи"
	FROM "Ранжирование"
	WHERE "Ранг" = 1
	ORDER BY "Суммарные продажи" DESC;




-- 5. Показать магазины, у которых прогноз продаж от 2 до 4 млн. р. в Июле

	SELECT "Код магазина",SUM("Прогноз продаж") as SUM
	FROM Тест_ПрогнозПродаж
	WHERE "Прогноз продаж" >= 2000000 AND "Прогноз продаж" <= 4000000
		AND DATE("Дата продаж") BETWEEN '2024-07-01' AND '2024-07-31'
	GROUP BY "Код магазина"
	ORDER BY SUM DESC;




-- 6. Показать средний прогноз продаж по каждому филиалу

	SELECT m."Филиал", ROUND(AVG(p."Прогноз продаж"),0) AS "Средний прогноз"
	FROM  Тест_ПрогнозПродаж AS p
	LEFT JOIN Тест_Магазины AS m ON m."Код магазина" = p."Код магазина" 
	GROUP BY m."Филиал";



-- 7. Определить ТОП 5 магазинов с максимальными продажами в каждом месяце


	WITH "Ранжирование" AS (
 		SELECT "Код магазина",
  			TO_CHAR(DATE_TRUNC('month', "Дата продаж"), 'MM.YYYY') AS "Месяц",
   			SUM("Прогноз продаж") AS "Продажи",
   			ROW_NUMBER() OVER (PARTITION BY TO_CHAR(DATE_TRUNC('month', "Дата продаж"), 'MM.YYYY') 
				ORDER BY SUM("Прогноз продаж") DESC) AS "Ранг"
  		FROM  Тест_ПрогнозПродаж
  		GROUP BY  "Код магазина", "Месяц"
	)	

	SELECT "Код магазина",  "Месяц",  "Продажи"
	FROM "Ранжирование"
	WHERE "Ранг" <= 5;




-- 8. Выбрать из V_WHS торговый объект с 4-м от минимального уровнем потенциала. Подсказка: рекомендуется использовать ранжирование

	WITH "Ранжирование" AS (
		SELECT *, ROW_NUMBER() OVER (ORDER BY POTENTIAL) AS "Ранг"
		FROM V_WHS
	)

	SELECT "Код магазина",  "Имя",  "Формат", POTENTIAL
	FROM "Ранжирование"
	WHERE "Ранг" = 4;



-- 9. Составить запрос, который всегда будет показывать дату вчерашнего числа со временем 2:21.

    	SELECT  TO_CHAR((CURRENT_DATE - INTERVAL'1 day' + INTERVAL'2 hours 21 minutes'), 'DD.MM.YYYY HH24:MI') AS date_time; 




